---
title: Troubleshooting Entity Framework performance problems
date: 2015-05-20 23:14:04
tags:
    - Entity Framework
    - Performance Tuning
---
The Problem

Some of our data services were running slower than we liked, a lot slower.
Since our Web Api services are using Linq to Entities behind the scenes, I suspected the SQL being generated by EF might not be optimized.
I fired up SQL Profiler and my suspicions were confirmed.

There were two significant problems with the parameters EF was generating:

varchar types were being cast to nvarchar
smallint types were being cast to int
Nvarchar parameters in string queries

With the first problem I saw this in my Where clause when I was checking out queries in Profiler:

1
@MyVarcharParm = N'myStringValue'
Brian Sullivan has a fantastic article explaining this and his solution is great, decorate the property in your model.

1
2
[Column(TypeName = "varchar")]
public string MyStringProperty { get; set; }
This reduced my query times by an order of magnitude!

Smallint cast as int

The second problem also lies in the Where clause:

1
CAST ([Extent1].[MySmallintProperty] AS int) = @p__linq__0
StackOverflow came to the rescue. I’ll let them give a detailed explanation…

My Linq statement looked like

1
.Where(x => x.MySmallintProperty == myShortValue)
so I changed it to

1
.Where(x => x.MySmallintProperty.Equals(myShortValue))
This also reduced my query times.