---
title: Troubleshooting Entity Framework performance problems
date: 2015-05-20 23:14:04
tags:
    - Entity Framework
    - Performance Tuning
---
![](/content/images/2015/ef.jpg)

## The Problem

Some of our data services were running slower than we liked, a lot slower.
Since our Web Api services are using Linq to Entities behind the scenes, I suspected the SQL being generated by EF might not be optimized.
I fired up SQL Profiler and my suspicions were confirmed.

There were two significant problems with the parameters EF was generating:

1. varchar types were being cast to nvarchar
2. smallint types were being cast to int

## Nvarchar parameters in string queries

With the first problem I saw this in my Where clause when I was checking out queries in Profiler:

```sql
@MyVarcharParm = N'myStringValue'
```

Brian Sullivan has a fantastic [article](http://www.sullivansoftdev.com/blog/2013/04/02/entity-framework-code-first-performance-issue-with-string-queries/) explaining this and his [solution](http://stackoverflow.com/questions/15767803/entity-framework-query-slow-but-same-sql-in-sqlquery-is-fast) is great, decorate the property in your model.

```csharp
[Column(TypeName = "varchar")]
public string MyStringProperty { get; set; }
```

This reduced my query times by an order of magnitude!

## Smallint cast as int

The second problem also lies in the Where clause:

```sql
CAST ([Extent1].[MySmallintProperty] AS int) = @p__linq__0
```

StackOverflow came to the [rescue](http://stackoverflow.com/questions/22149456/entity-framework-ridiculous-query-casting-smallint-to-int-for-comparison). I’ll let them give a detailed explanation…

My Linq statement looked like:
```csharp
.Where(x => x.MySmallintProperty == myShortValue)
```

so I changed it to:
```csharp
.Where(x => x.MySmallintProperty.Equals(myShortValue))
```
This also reduced my query times.